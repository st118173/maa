!function(e,t){var i={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},n={triggerChar:"@",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%= value %></span></strong>")}},r={htmlEncode:function(e){return t.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var i=e.createTextRange();i.move("character",t),i.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},o=function(o){function s(){N=e(D),"true"!==N.attr("data-mentions-input")&&(I=N.parent(),A=e(o.templates.wrapper()),N.wrapAll(A),A=I.find("> div.mentions-input-box"),N.attr("data-mentions-input","true"),N.bind("keydown",x),N.bind("keypress",w),N.bind("click",v),N.bind("blur",y),navigator.userAgent.indexOf("MSIE 8")>-1?N.bind("propertychange",b):N.bind("input",b),o.elastic&&N.elastic())}function a(){F=e(o.templates.autocompleteList()),F.appendTo(A),F.delegate("li","mousedown",g)}function l(){P=e(o.templates.mentionsOverlay()),P.prependTo(A)}function u(){var e=f();t.each(q,function(t){var i=o.templates.mentionItemSyntax(t);e=e.replace(new RegExp(r.regexpEncode(t.value),"g"),i)});var i=r.htmlEncode(e);t.each(q,function(e){var n=t.extend({},e,{value:r.htmlEncode(e.value)}),s=o.templates.mentionItemSyntax(n),a=o.templates.mentionItemHighlight(n);i=i.replace(new RegExp(r.regexpEncode(s),"g"),a)}),i=i.replace(/\n/g,"<br />"),i=i.replace(/ {2}/g,"&nbsp; "),N.data("messageText",e),N.trigger("updated"),P.find("div").html(i)}function c(){O=[]}function d(){var e=f();q=t.reject(q,function(t){return!t.value||e.indexOf(t.value)==-1}),q=t.compact(q)}function h(e){var i=f(),n=new RegExp("\\"+o.triggerChar+L,"gi");n.exec(i);var s=n.lastIndex-L.length-1,a=n.lastIndex,l=i.substr(0,s),d=i.substr(a,i.length),h=(l+e.value).length+1;t.find(q,function(t){return t.id==e.id})||q.push(e),c(),L="",_();var p=l+e.value+" "+d;N.val(p),N.trigger("mention"),u(),N.focus(),r.setCaratPosition(N[0],h)}function f(){return e.trim(N.val())}function p(t){var i,n,r,o,s,a,l,u,c,d,h;if((c=t[0])&&e(c).is("textarea")&&null!=c.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},u=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"],d=0,h=u.length;d<h;d++)s=u[d],l[s]=e(c).css(s);return r=document.createElement("div"),e(r).css(l),e(c).after(r),n=document.createTextNode(c.value.substring(0,c.selectionEnd)),i=document.createTextNode(c.value.substring(c.selectionEnd)),o=document.createElement("span"),o.innerHTML="&nbsp;",r.appendChild(n),r.appendChild(o),r.appendChild(i),r.scrollTop=c.scrollTop,a=e(o).position(),e(r).remove(),a}}function m(){var t=e(N).offset().top,i=e("body").offset().top,n=e(window).scrollTop();n>t&&e(window).scrollTop(t-i)}function g(){var t=e(this),i=M[t.attr("data-uid")];return h(i),m(),!1}function v(){c()}function y(){_()}function b(){u(),d();var e=t.lastIndexOf(O,o.triggerChar);e>-1&&(L=O.slice(e+1).join(""),L=r.rtrim(L),t.defer(t.bind(T,this,L)))}function w(e){if(e.keyCode!==i.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);O.push(t)}}function x(n){if(n.keyCode===i.LEFT||n.keyCode===i.RIGHT||n.keyCode===i.HOME||n.keyCode===i.END)return t.defer(c),void(navigator.userAgent.indexOf("MSIE 9")>-1&&t.defer(u));if(n.keyCode===i.BACKSPACE)return void(O=O.slice(0,-1+O.length));if(!F.is(":visible"))return!0;switch(n.keyCode){case i.UP:case i.DOWN:var r=null;return r=n.keyCode===i.DOWN?j&&j.length?j.next():F.find("li").first():e(j).prev(),r.length&&C(r),!1;case i.RETURN:case i.TAB:if(j&&j.length)return j.trigger("mousedown"),!1}return!0}function _(){j=null,F.empty().hide()}function C(e){e.addClass(o.classes.autoCompleteItemActive),e.siblings().removeClass(o.classes.autoCompleteItemActive),j=e}function k(i,n){if(F.show(),!o.allowRepeat){var s=t.pluck(q,"value");n=t.reject(n,function(e){return t.include(s,e.name)})}if(!n.length)return void _();F.empty();var a=e("<ul>").appendTo(F).hide();t.each(n,function(n,s){var l=t.uniqueId("mention_");M[l]=t.extend({},n,{value:n.name});var u=e(o.templates.autocompleteListItem({id:r.htmlEncode(n.id),display:r.htmlEncode(n.name),type:r.htmlEncode(n.type),content:r.highlightTerm(r.htmlEncode(n.display?n.display:n.name),i)})).attr("data-uid",l);if(0===s&&C(u),o.showAvatars){var c;c=e(n.avatar?o.templates.autocompleteListItemAvatar({avatar:n.avatar}):o.templates.autocompleteListItemIcon({icon:n.icon})),c.prependTo(u)}u=u.appendTo(a)}),F.show(),o.onCaret&&S(F,N),a.show()}function T(e){e&&e.length&&e.length>=o.minChars?o.onDataRequest.call(this,"search",e,function(t){k(e,t)}):_()}function S(e,t){var i=p(t),n=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",i.left),e.css("top",n+i.top);var r=t.offset().left+t.width(),o=e.offset().left+e.width();r<=o&&e.css("left",Math.abs(e.position().left-(o-r)))}function E(e){q=[];for(var t,i=r.htmlEncode(e),n=new RegExp("("+o.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),s=i;null!=(t=n.exec(i));)s=s.replace(t[0],t[1]+t[2]),q.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});N.val(s),u()}var D,N,I,F,A,P,j,q=[],M={},O=[],L="";return o=e.extend(!0,{},n,o),{init:function(e){D=e,s(),a(),l(),E(o.defaultValue),o.prefillMention&&h(o.prefillMention)},val:function(e){t.isFunction(e)&&e.call(this,q.length?N.data("messageText"):f())},reset:function(){E()},getMentions:function(e){t.isFunction(e)&&e.call(this,q)}}};e.fn.mentionsInput=function(i,n){var r=arguments;return"object"!=typeof i&&i||(n=i),this.each(function(){var s=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new o(n));return t.isFunction(s[i])?s[i].apply(this,Array.prototype.slice.call(r,1)):"object"!=typeof i&&i?void e.error("Method "+i+" does not exist"):s.init.call(this,this)})}}(jQuery,_);