!function(e,t){var n={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},i={triggerChar:"@",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%= value %></span></strong>")}},r={htmlEncode:function(e){return t.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},o=function(o){function s(){L=e(M),"true"!==L.attr("data-mentions-input")&&(E=L.parent(),N=e(o.templates.wrapper()),L.wrapAll(N),N=E.find("> div.mentions-input-box"),L.attr("data-mentions-input","true"),L.bind("keydown",w),L.bind("keypress",_),L.bind("click",v),L.bind("blur",y),navigator.userAgent.indexOf("MSIE 8")>-1?L.bind("propertychange",b):L.bind("input",b),o.elastic&&L.elastic())}function a(){j=e(o.templates.autocompleteList()),j.appendTo(N),j.delegate("li","mousedown",g)}function l(){I=e(o.templates.mentionsOverlay()),I.prependTo(N)}function u(){var e=p();t.each(P,function(t){var n=o.templates.mentionItemSyntax(t);e=e.replace(new RegExp(r.regexpEncode(t.value),"g"),n)});var n=r.htmlEncode(e);t.each(P,function(e){var i=t.extend({},e,{value:r.htmlEncode(e.value)}),s=o.templates.mentionItemSyntax(i),a=o.templates.mentionItemHighlight(i);n=n.replace(new RegExp(r.regexpEncode(s),"g"),a)}),n=n.replace(/\n/g,"<br />"),n=n.replace(/ {2}/g,"&nbsp; "),L.data("messageText",e),L.trigger("updated"),I.find("div").html(n)}function c(){H=[]}function d(){var e=p();P=t.reject(P,function(t){return!t.value||e.indexOf(t.value)==-1}),P=t.compact(P)}function h(e){var n=p(),i=new RegExp("\\"+o.triggerChar+O,"gi");i.exec(n);var s=i.lastIndex-O.length-1,a=i.lastIndex,l=n.substr(0,s),d=n.substr(a,n.length),h=(l+e.value).length+1;t.find(P,function(t){return t.id==e.id})||P.push(e),c(),O="",x();var f=l+e.value+" "+d;L.val(f),L.trigger("mention"),u(),L.focus(),r.setCaratPosition(L[0],h)}function p(){return e.trim(L.val())}function f(t){var n,i,r,o,s,a,l,u,c,d,h;if((c=t[0])&&e(c).is("textarea")&&null!=c.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},u=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"],d=0,h=u.length;d<h;d++)s=u[d],l[s]=e(c).css(s);return r=document.createElement("div"),e(r).css(l),e(c).after(r),i=document.createTextNode(c.value.substring(0,c.selectionEnd)),n=document.createTextNode(c.value.substring(c.selectionEnd)),o=document.createElement("span"),o.innerHTML="&nbsp;",r.appendChild(i),r.appendChild(o),r.appendChild(n),r.scrollTop=c.scrollTop,a=e(o).position(),e(r).remove(),a}}function m(){var t=e(L).offset().top,n=e("body").offset().top,i=e(window).scrollTop();i>t&&e(window).scrollTop(t-n)}function g(){var t=e(this),n=F[t.attr("data-uid")];return h(n),m(),!1}function v(){c()}function y(){x()}function b(){u(),d();var e=t.lastIndexOf(H,o.triggerChar);e>-1&&(O=H.slice(e+1).join(""),O=r.rtrim(O),t.defer(t.bind(C,this,O)))}function _(e){if(e.keyCode!==n.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);H.push(t)}}function w(i){if(i.keyCode===n.LEFT||i.keyCode===n.RIGHT||i.keyCode===n.HOME||i.keyCode===n.END)return t.defer(c),void(navigator.userAgent.indexOf("MSIE 9")>-1&&t.defer(u));if(i.keyCode===n.BACKSPACE)return void(H=H.slice(0,-1+H.length));if(!j.is(":visible"))return!0;switch(i.keyCode){case n.UP:case n.DOWN:var r=null;return r=i.keyCode===n.DOWN?A&&A.length?A.next():j.find("li").first():e(A).prev(),r.length&&k(r),!1;case n.RETURN:case n.TAB:if(A&&A.length)return A.trigger("mousedown"),!1}return!0}function x(){A=null,j.empty().hide()}function k(e){e.addClass(o.classes.autoCompleteItemActive),e.siblings().removeClass(o.classes.autoCompleteItemActive),A=e}function T(n,i){if(j.show(),!o.allowRepeat){var s=t.pluck(P,"value");i=t.reject(i,function(e){return t.include(s,e.name)})}if(!i.length)return void x();j.empty();var a=e("<ul>").appendTo(j).hide();t.each(i,function(i,s){var l=t.uniqueId("mention_");F[l]=t.extend({},i,{value:i.name});var u=e(o.templates.autocompleteListItem({id:r.htmlEncode(i.id),display:r.htmlEncode(i.name),type:r.htmlEncode(i.type),content:r.highlightTerm(r.htmlEncode(i.display?i.display:i.name),n)})).attr("data-uid",l);if(0===s&&k(u),o.showAvatars){var c;c=e(i.avatar?o.templates.autocompleteListItemAvatar({avatar:i.avatar}):o.templates.autocompleteListItemIcon({icon:i.icon})),c.prependTo(u)}u=u.appendTo(a)}),j.show(),o.onCaret&&S(j,L),a.show()}function C(e){e&&e.length&&e.length>=o.minChars?o.onDataRequest.call(this,"search",e,function(t){T(e,t)}):x()}function S(e,t){var n=f(t),i=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",n.left),e.css("top",i+n.top);var r=t.offset().left+t.width(),o=e.offset().left+e.width();r<=o&&e.css("left",Math.abs(e.position().left-(o-r)))}function D(e){P=[];for(var t,n=r.htmlEncode(e),i=new RegExp("("+o.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),s=n;null!=(t=i.exec(n));)s=s.replace(t[0],t[1]+t[2]),P.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});L.val(s),u()}var M,L,E,j,N,I,A,P=[],F={},H=[],O="";return o=e.extend(!0,{},i,o),{init:function(e){M=e,s(),a(),l(),D(o.defaultValue),o.prefillMention&&h(o.prefillMention)},val:function(e){t.isFunction(e)&&e.call(this,P.length?L.data("messageText"):p())},reset:function(){D()},getMentions:function(e){t.isFunction(e)&&e.call(this,P)}}};e.fn.mentionsInput=function(n,i){var r=arguments;return"object"!=typeof n&&n||(i=n),this.each(function(){var s=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new o(i));return t.isFunction(s[n])?s[n].apply(this,Array.prototype.slice.call(r,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):s.init.call(this,this)})}}(jQuery,_);