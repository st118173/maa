!function(e){var t={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:!1,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,theme:null,zindex:999,resultsLimit:null,resultsFormatter:function(e){return"<li>"+e[this.propertyToSearch]+"</li>"},tokenFormatter:function(e){return"<li><p>"+e[this.propertyToSearch]+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",onResult:null,onAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:!1},n={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"},i={BEFORE:0,AFTER:1,END:2},r={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},s={init:function(n,i){var r=e.extend({},t,i||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,n,r))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(e){return this.data("tokenInputObject").add(e),this},remove:function(e){return this.data("tokenInputObject").remove(e),this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(e){return this.data("tokenInputObject").toggleDisabled(e),this}};e.fn.tokenInput=function(e){return s[e]?s[e].apply(this,Array.prototype.slice.call(arguments,1)):s.init.apply(this,arguments)},e.TokenList=function(t,s,o){function a(t){"boolean"==typeof t?o.disabled=t:o.disabled=!o.disabled,H.prop("disabled",o.disabled),$.toggleClass(o.classes.disabled,o.disabled),N&&p(e(N),i.END),O.prop("disabled",o.disabled)}function l(){if(null!==o.tokenLimit&&A>=o.tokenLimit)return H.hide(),void y()}function u(){if(j!==(j=H.val())){var e=j.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");z.html(e),H.width(z.width()+30)}}function d(t){var n=e(o.tokenFormatter(t)),i=t.readonly===!0;i&&n.addClass(o.classes.tokenReadOnly),n.addClass(o.classes.token).insertBefore(U),i||e("<span>"+o.deleteText+"</span>").addClass(o.classes.tokenDelete).appendTo(n).click(function(){if(!o.disabled)return m(e(this).parent()),O.change(),!1});var r=t;return e.data(n.get(0),"tokeninput",t),I=I.slice(0,F).concat([r]).concat(I.slice(F)),F++,g(I,O),A+=1,null!==o.tokenLimit&&A>=o.tokenLimit&&(H.hide(),y()),n}function c(t){var n=o.onAdd;if(A>0&&o.preventDuplicates){var i=null;if($.children().each(function(){var n=e(this),r=e.data(n.get(0),"tokeninput");if(r&&r.id===t.id)return i=n,!1}),i)return h(i),U.insertAfter(i),void C(H)}(null==o.tokenLimit||A<o.tokenLimit)&&(d(t),l()),H.val(""),y(),e.isFunction(n)&&n.call(O,t)}function h(e){o.disabled||(e.addClass(o.classes.selectedToken),N=e.get(0),H.val(""),y())}function p(e,t){e.removeClass(o.classes.selectedToken),N=null,t===i.BEFORE?(U.insertBefore(e),F--):t===i.AFTER?(U.insertAfter(e),F++):(U.appendTo($),F=A),C(H)}function f(t){var n=N;N&&p(e(N),i.END),n===t.get(0)?p(t,i.END):h(t)}function m(t){var n=e.data(t.get(0),"tokeninput"),i=o.onDelete,r=t.prevAll().length;r>F&&r--,t.remove(),N=null,C(H),I=I.slice(0,r).concat(I.slice(r+1)),r<F&&F--,g(I,O),A-=1,null!==o.tokenLimit&&(H.show().val(""),C(H)),e.isFunction(i)&&i.call(O,n)}function g(t,n){var i=e.map(t,function(e){return"function"==typeof o.tokenValue?o.tokenValue.call(this,e):e[o.tokenValue]});n.val(i.join(o.tokenDelimiter))}function y(){W.hide().empty(),R=null}function v(){W.css({position:"absolute",top:e($).offset().top+e($).outerHeight(),left:e($).offset().left,width:e($).outerWidth(),"z-index":o.zindex}).show()}function b(){o.searchingText&&(W.html("<p>"+o.searchingText+"</p>"),v())}function _(){o.hintText&&(W.html("<p>"+o.hintText+"</p>"),v())}function w(e){return e.replace(V,"\\$&")}function x(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+w(t)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function k(e,t,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+w(t)+")(?![^<>]*>)(?![^&;]+;)","g"),x(t,n))}function M(t,n){if(n&&n.length){W.empty();var i=e("<ul>").appendTo(W).mouseover(function(t){T(e(t.target).closest("li"))}).mousedown(function(t){return c(e(t.target).closest("li").data("tokeninput")),O.change(),!1}).hide();o.resultsLimit&&n.length>o.resultsLimit&&(n=n.slice(0,o.resultsLimit)),e.each(n,function(n,r){var s=o.resultsFormatter(r);s=k(s,r[o.propertyToSearch],t),s=e(s).appendTo(i),n%2?s.addClass(o.classes.dropdownItem):s.addClass(o.classes.dropdownItem2),0===n&&T(s),e.data(s.get(0),"tokeninput",r)}),v(),o.animateDropdown?i.slideDown("fast"):i.show()}else o.noResultsText&&(W.html("<p>"+o.noResultsText+"</p>"),v())}function T(t){t&&(R&&L(e(R)),t.addClass(o.classes.selectedDropdownItem),R=t.get(0))}function L(e){e.removeClass(o.classes.selectedDropdownItem),R=null}function S(){var t=H.val();t&&t.length&&(N&&p(e(N),i.AFTER),t.length>=o.minChars?(b(),clearTimeout(Y),Y=setTimeout(function(){D(t)},o.searchDelay)):y())}function D(t){var n=t+E(),i=P.get(n);if(i)M(t,i);else if(o.url){var r=E(),s={};if(s.data={},r.indexOf("?")>-1){var a=r.split("?");s.url=a[0];var l=a[1].split("&");e.each(l,function(e,t){var n=t.split("=");s.data[n[0]]=n[1]})}else s.url=r;s.data[o.queryParam]=t,s.type=o.method,s.dataType=o.contentType,o.crossDomain&&(s.dataType="jsonp"),s.success=function(i){e.isFunction(o.onResult)&&(i=o.onResult.call(O,i)),P.add(n,o.jsonContainer?i[o.jsonContainer]:i),H.val()===t&&M(t,o.jsonContainer?i[o.jsonContainer]:i)},e.ajax(s)}else if(o.local_data){var u=e.grep(o.local_data,function(e){return e[o.propertyToSearch].toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(o.onResult)&&(u=o.onResult.call(O,u)),P.add(n,u),M(t,u)}}function E(){var e=o.url;return"function"==typeof o.url&&(e=o.url.call(o)),e}function C(e){setTimeout(function(){e.focus()},50)}if("string"===e.type(s)||"function"===e.type(s)){o.url=s;var q=E();void 0===o.crossDomain&&"string"==typeof q&&(q.indexOf("://")===-1?o.crossDomain=!1:o.crossDomain=location.href.split(/\/+/g)[1]!==q.split(/\/+/g)[1])}else"object"==typeof s&&(o.local_data=s);o.classes?o.classes=e.extend({},n,o.classes):o.theme?(o.classes={},e.each(n,function(e,t){o.classes[e]=t+"-"+o.theme})):o.classes=n;var Y,j,I=[],A=0,P=new e.TokenList.Cache,H=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",o.idPrefix+t.id).focus(function(){return!o.disabled&&(null!==o.tokenLimit&&o.tokenLimit===A||_(),void $.addClass(o.classes.focused))}).blur(function(){y(),e(this).val(""),$.removeClass(o.classes.focused)}).bind("keyup keydown blur update",u).keydown(function(t){var n,s;switch(t.keyCode){case r.LEFT:case r.RIGHT:case r.UP:case r.DOWN:if(e(this).val()){var o=null;o=t.keyCode===r.DOWN||t.keyCode===r.RIGHT?e(R).next():e(R).prev(),o.length&&T(o)}else n=U.prev(),s=U.next(),n.length&&n.get(0)===N||s.length&&s.get(0)===N?t.keyCode===r.LEFT||t.keyCode===r.UP?p(e(N),i.BEFORE):p(e(N),i.AFTER):t.keyCode!==r.LEFT&&t.keyCode!==r.UP||!n.length?t.keyCode!==r.RIGHT&&t.keyCode!==r.DOWN||!s.length||h(e(s.get(0))):h(e(n.get(0)));return!1;case r.BACKSPACE:if(n=U.prev(),!e(this).val().length)return N?(m(e(N)),O.change()):n.length&&h(e(n.get(0))),!1;1===e(this).val().length?y():setTimeout(function(){S()},5);break;case r.TAB:case r.ENTER:case r.NUMPAD_ENTER:case r.COMMA:if(R)return c(e(R).data("tokeninput")),O.change(),!1;break;case r.ESCAPE:return y(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){S()},5)}}),O=e(t).hide().val("").focus(function(){C(H)}).blur(function(){H.blur()}),N=null,F=0,R=null,$=e("<ul />").addClass(o.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?f(n):(N&&p(e(N),i.END),C(H))}).mouseover(function(t){var n=e(t.target).closest("li");n&&N!==this&&n.addClass(o.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&N!==this&&n.removeClass(o.classes.highlightedToken)}).insertBefore(O),U=e("<li />").addClass(o.classes.inputToken).appendTo($).append(H),W=e("<div>").addClass(o.classes.dropdown).appendTo("body").hide(),z=e("<tester/>").insertAfter(H).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:H.css("fontSize"),fontFamily:H.css("fontFamily"),fontWeight:H.css("fontWeight"),letterSpacing:H.css("letterSpacing"),whiteSpace:"nowrap"});O.val("");var B=o.prePopulate||O.data("pre");o.processPrePopulate&&e.isFunction(o.onResult)&&(B=o.onResult.call(O,B)),B&&B.length&&e.each(B,function(e,t){d(t),l()}),o.disabled&&a(!0),e.isFunction(o.onReady)&&o.onReady.call(),this.clear=function(){$.children("li").each(function(){0===e(this).children("input").length&&m(e(this))})},this.add=function(e){c(e)},this.remove=function(t){$.children("li").each(function(){if(0===e(this).children("input").length){var n=e(this).data("tokeninput"),i=!0;for(var r in t)if(t[r]!==n[r]){i=!1;break}i&&m(e(this))}})},this.getTokens=function(){return I},this.toggleDisabled=function(e){a(e)};var V=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g")},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),i={},r=0,s=function(){i={},r=0};this.add=function(e,t){r>n.max_size&&s(),i[e]||(r+=1),i[e]=t},this.get=function(e){return i[e]}}}(jQuery);